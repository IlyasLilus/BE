<!DOCTYPE html>
<html>
<head>
    <style>
        #drag-items {
            position:absolute;
            bottom: 0;
            left: 0;
            display: flex;
        }
        .draggable {
            width: 50px;
            height: 50px;
            margin: 10px;
        }
        #pc {
            background-image: url("image/desktop-computer.svg");
            background-size: cover;
        }
        #router {
            background-image: url("image/cisco-router-icon.webp");
            background-size:cover
        }
        #wire {
            background-image: url("image/cable.svg");
            background-size: cover;
        }
        #context-menu {
            display: none;
            position: absolute;
            width: 100px;
            background-color: #fff;
            border: 1px solid #ddd;
        }
        #context-menu button {
            all: unset;
            width: 100%;
            padding: 5px;
        }

        .draggable.clone {
            background-color: #ffffff;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border: 1px solid black;
        }
        
    </style>
    <script src="https://cdn.jsdelivr.net/npm/interactjs@1.10.11/dist/interact.min.js"></script>
</head>
<body>

<section id="drag-items">
    <div id="wire" class="draggable"></div>
    <div id="pc" class="draggable"></div>
    <div id="router" class="draggable"></div>
</section>

<canvas id="canvas"></canvas>

<div id="context-menu">
    <button id="configurer">Configurer...</button>
    <button id="delete">Supprimer</button>
    <button id="cloner">Cloner</button>
</div>

<div id="config-modal" style="display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div style="background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%;">
        <h2 id="config-title">Configuration</h2>
        <form id="config-form">
            <label for="ip-address">IP Address:</label><br>
            <input type="text" id="ip-address" name="ip-address"><br>
            <label for="network" id="network-label" style="display: none;">Network:</label><br>
            <input type="text" id="network" name="network" style="display: none;"><br>
            <input type="submit" value="Submit">
        </form>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const contextMenu = document.getElementById('context-menu');
    const deleteButton = document.getElementById('delete');
    const clonerButton = document.getElementById('cloner');
    const configButton = document.getElementById('configurer');
    const configModal = document.getElementById('config-modal');
    const configForm = document.getElementById('config-form');
    const configTitle = document.getElementById('config-title');
    const ipAddressInput = document.getElementById('ip-address');
    const networkInput = document.getElementById('network');
    const networkLabel = document.getElementById('network-label');
    let selectedElement = null;
    let selectedCable = null;
    let selectedElements = [];
    let connexions = [];
    let pcs = [document.getElementById('pc')];
    let routers = [document.getElementById('router')];
    let equipmentCables = {};

    interact('.draggable').on('tap', function (event) {
        if (event.target.id === 'wire') {
            selectedCable = event.target;
        } else if (selectedCable) {
            if (event.target.id === 'pc' && selectedElements.length > 0 && selectedElements[0].id === 'pc') {
                return;
            }

            let count = 0;
            for (let connection of connexions) {
                if (connection.start === event.target || connection.end === event.target) {
                    count++;
                }
            }

            if (count < 4) {
                selectedElements.push(event.target);
                if (selectedElements.length === 2) {
                    const EltSelect1 = selectedElements[0].getBoundingClientRect();
                    const EltSelect2 = selectedElements[1].getBoundingClientRect();
                    ctx.beginPath();
                    ctx.moveTo(EltSelect1.left + EltSelect1.width / 2, EltSelect1.top + EltSelect1.height / 2);
                    ctx.lineTo(EltSelect2.left + EltSelect2.width / 2, EltSelect2.top + EltSelect2.height / 2);
                    ctx.stroke();
                    connexions.push({
                        start: selectedElements[0],
                        end: selectedElements[1]
                    });


                    if (!equipmentCables[selectedElements[0].id]) {
                        equipmentCables[selectedElements[0].id] = [];
                    }
                    equipmentCables[selectedElements[0].id].push(ctx);

                    if (!equipmentCables[selectedElements[1].id]) {
                        equipmentCables[selectedElements[1].id] = [];
                    }
                    equipmentCables[selectedElements[1].id].push(ctx);

                    selectedElements = [];
                    selectedCable = null;
                }
            }
        }
    });

    interact('#drag-items').dropzone({
        accept: '.no-class',
        overlap: 0.75,
        ondrop: function (event) {
            event.relatedTarget.style.transform = 'none';
            event.relatedTarget.setAttribute('data-x', 0);
            event.relatedTarget.setAttribute('data-y', 0);
        }
    });

    interact('.draggable')
        .draggable({
            inertia: true,
            autoScroll: true,
            onmove: dragMoveListener,
        })
        .on('doubletap', function (event) {
            selectedElement = event.target;
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${event.pageX}px`;
            contextMenu.style.top = `${event.pageY}px`;
            event.preventDefault();
        });

        deleteButton.addEventListener('click', function () {
            if (equipmentCables[selectedElement.id]) {
                for (let cable of equipmentCables[selectedElement.id]) {
                    cable.clearRect(0, 0, canvas.width, canvas.height);
                }
            }
            const clone = selectedElement.cloneNode();
            clone.style.transform = 'none';
            clone.setAttribute('data-x', 0);
            clone.setAttribute('data-y', 0);
            document.getElementById('drag-items').appendChild(clone);
            interact(clone)
                .draggable({
                inertia: true,
                autoScroll: true,
                onmove: dragMoveListener
                });
            selectedElement.parentNode.removeChild(selectedElement);
            contextMenu.style.display = 'none';
            connexions = connexions.filter(connection => connection.start !== selectedElement && connection.end !== selectedElement);
        });

    clonerButton.addEventListener('click', function () {
        const clone = selectedElement.cloneNode();
        clone.classList.add('clone');
        const x = selectedElement.getAttribute('data-x') || 0;
        const y = selectedElement.getAttribute('data-y') || 0;
        document.body.appendChild(clone);
        interact(clone)
            .draggable({
                inertia: true,
                autoScroll: true,
                onmove: dragMoveListener
            });
        selectedElement.parentNode.insertBefore(clone, selectedElement.nextSibling);
        contextMenu.style.display = 'none';

        if (selectedElement.id === 'pc') {
            pcs.push(clone);
        } else if (selectedElement.id === 'router') {
            routers.push(clone);
        }
    });

    function dragMoveListener (event) {
        var target = event.target,
            x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
            y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

        target.style.webkitTransform =
        target.style.transform =
            'translate(' + x + 'px, ' + y + 'px)';

        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);

        
        for (let connection of connexions) {
            if (connection.start === target || connection.end === target) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const rect1 = connection.start.getBoundingClientRect();
            const rect2 = connection.end.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(rect1.left + rect1.width / 2, rect1.top + rect1.height / 2);
            ctx.lineTo(rect2.left + rect2.width / 2, rect2.top + rect2.height / 2);
            ctx.stroke();
            }
        }
       
    configButton.addEventListener('click', function () {
        if (selectedElement.id === 'pc') {
            configTitle.textContent = 'PC Configuration';
            networkInput.style.display = 'none';
            networkLabel.style.display = 'none';
        } else if (selectedElement.id === 'router') {
            configTitle.textContent = 'Router Configuration';
            networkInput.style.display = 'block';
            networkLabel.style.display = 'block';
        }
        configModal.style.display = 'block';
    });

    configForm.addEventListener('submit', function (event) {
        event.preventDefault();
        configModal.style.display = 'none';
    });
    }
</script>

</body>
</html>

<!-- Dans un tableau : conserver les deux éléments et le canva. OU (favorite :) un tableau de l'élément et de tous les canvas qui lui sont associé -->